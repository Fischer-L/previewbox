<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="stylesheet" media="all" href="lib/mocha.css">
	
	<style>
		#anchorsHolder {
			width : 90%;
			margin : 0 auto;
			display : none;
		}
		#anchorsHolder a {
			padding : 8px;
			background-color: #6DB4ED;
			font-size : 16px;
			line-height : 2;
		}
		.aWrp {
			width : 25%;
			margin : 4%;
			float : left;
		}
		@media (max-width : 768px) {
		
			.aWrp {
				width : 90%;
				margin : 5%;
			}
		}
	</style>
</head>
<body>
	
	<div id="mocha"></div>
	
	<div id="anchorsHolder">
		<div class="aWrp">
			<a class="test previewbox-anchor" href="http://css-tricks.com/blurry-transparent-header-effect-ios7-css/">Blurry Transparent Header Effect from iOS7 in CSS</a>
		</div>
		<div class="aWrp">
			<a class="test previewbox-anchor" href="//edition.cnn.com/SHOWBIZ/">CNN Entertainment</a>
		</div>
		<div class="aWrp">
			<a class="test" href="//www.reddit.com/">reddit</a>
		</div>
		<div class="aWrp">
			<a class="test" href="https://nyse.nyx.com/">NewYour Stock Exchange</a>
		</div>
		<div class="aWrp">
			<a class="test" href="//www.imdb.com/">IMDb</a>
		</div>
		<div class="aWrp">
			<a class="test" href="http://www.html5rocks.com/en/">HTML5 Rocks</a>
		</div>
		<div class="aWrp">
			<a class="test" href="//www.weather.com/">National and Local Weather</a>
		</div>
		<div class="aWrp">
			<a class="test previewbox-anchor" href="http://techcrunch.com/2013/10/05/the-potential-and-pitfalls-of-twitters-mobile-business/">The Potential And Pitfalls Of Twitterâ€™s Mobile Business</a>
		</div>
<div style="width:10px; heigth:500px"></div>
		<div class="aWrp">
			<a class="test" href="http://en.wikipedia.org/wiki/Main_Page">Welcome to Wikipedia</a>
		</div>
	</div>
	
	<script src="previewbox.js"></script>
	<script src="lib/mocha.js"></script>
	<script src="lib/proclaim.js"></script>
	<script>
		var mochaTest = {
			
				flag_run_mocha_tests : 1,
				
				flag_state_pass : "passed",
				
				flag_isPass : true,
				
				isPass : function (suite) {				
					
					if (suite instanceof Object) {
					
						var i;
								
						for (i = suite.tests.length - 1; i >= 0; i--) {
														
							if (suite.tests[i].state !== this.flag_state_pass) return (this.flag_isPass = false);
						}
													
						for (i = suite.suites.length - 1; i >= 0; i--) {
														
							if (!this.isPass(suite.suites[i])) return this.flag_isPass;
						}
					}
					
					return this.flag_isPass;
				}
			},
			
			setupDemo = function (mochaErr) {
		
				if (!mochaErr && mochaTest.isPass(mocha.suite)) {
					
					document.querySelector("#mocha").style.display = "none";
					document.querySelector("#anchorsHolder").style.display = "block";
					
					for (var i = 0, as = document.querySelectorAll("#anchorsHolder a"); i < as.length; i++) {
						previewbox.regisAnchor(as[i]);
					}
					
					previewbox.changeStyles({
						iframeW : 999999,
						iframeH : 999999
					});
					
					previewbox.setSandbox("allow-scripts");	
				}				
			};
	</script>
	<script>
		/**
         * Mocha tests
		 */		 
		
		if (mochaTest.flag_run_mocha_tests) {
		
			mocha.setup("bdd");
			
			var assert = proclaim,
			
				assertAnchorRegistered = function (a) {	
					
					var expNodeType = 1,
						
						expAnchorType = 0;
						
					assert.notEqual(a, null, "assertAnchorRegistered but null");
					
					assert.isObject(a, "assertAnchorRegistered but not object");
					
					assert.strictEqual(a.nodeType, expNodeType, formaStr("assertAnchorRegistered but nodeType (actual , expected) = ({0}, {1})", a.nodeType, expNodeType));
					
					assert.greaterThanOrEqual(a.anchorType, 0, formaStr("assertAnchorRegistered but anchorType (actual < expected) => ({0} < {1})", a.anchorType, expAnchorType));
				},
				
				formaStr = function () { // From : http://jsfiddle.net/joquery/9KYaQ/
				
					// The string containing the format items (e.g. "{0}")
					// will and always has to be the first argument.
					var theString = arguments[0];
					
					// start with the second argument (i = 1)
					for (var i = 1; i < arguments.length; i++) {
						// "gm" = RegEx options for Global search (more than one instance)
						// and for Multiline search
						var regEx = new RegExp("\\{" + (i - 1) + "\\}", "gm");
						theString = theString.replace(regEx, arguments[i]);
					}
					
					return theString;
				};
			
			describe("previewbox", function () {
			
				describe("#setSandbox", function () {
					
					it("should set sandbox", function () {
						
						var v = "allow-same-origin allow-scripts allow-forms";
						
						assert.strictEqual(previewbox.setSandbox(v), v);						
					});					
				});				
			
				describe("#rmSandbox", function () {
					
					it("should remove sandbox", function () {
						
						previewbox.rmSandbox();
						
						assert.strictEqual(document.querySelector("#previewbox-iframe").getAttribute("sandbox"), null);
					});					
				});
							
				describe("#changeStyles", function () {
					
					it("should change styles", function () {
						
						var newStyles = {
								iframeW : 300,
								iframeH : 400,
								boxBorderColor : "#555",
								loadingImg : "url(./loading.gif)"
							},
							currentStys = previewbox.changeStyles(newStyles);
							
						assert.notEqual(currentStys, null, "The current style is null");
						
						assert.isObject(currentStys, "The returned style is not obj");
						
						for (var p in newStyles) {
						
							if (newStyles.hasOwnProperty(p)) {								
								assert.strictEqual(currentStys[p], newStyles[p], formaStr("The {0} style (actual, expected) = ({1}, {2})", p, currentStys[p], newStyles[p]));
							}
						}						
					});					
				});
							
				describe("#regisAnchor", function () {
					
					it("should register anchor", function () {
						
						var a = document.querySelectorAll("#anchorsHolder a");
						
						assertAnchorRegistered(previewbox.regisAnchor(a[a.length - 1]));
					});
				});
							
				describe("#regisBySearching", function () {
					
					it("should register anchors thru searching", function () {
						
						var expLength = 4,
						
							acs = previewbox.regisBySearching();
						
						assert.notEqual(acs, null, "No anchor regsiterd");
						
						assert.isObject(acs, "The returned value is not obj");
						
						assert.equal(acs.length, expLength, formaStr("The number of anchors registered (actual, expected) = ({0}, {1})", acs.length, expLength));
						
						for (var i = acs.length - 1; i >= 0; i--) {
							assertAnchorRegistered(acs[i]);
						}
					});
				});
								
			});			
			
			mocha.run(setupDemo);
			
		} else {
		
			setupDemo();
		}
	</script>
</body>
</html>